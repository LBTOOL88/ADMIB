<!--
  Trang quản trị cho dự án Long Bảo Tool A.I.  
  File này cung cấp giao diện cho quản trị viên đăng nhập, tạo tài khoản người dùng mới
  và nạp thêm năng lượng cho người dùng hiện có.  
  Để phù hợp với kiến trúc của dự án gốc, trang này sử dụng Firebase Authentication
  và Firestore. Sau khi đăng nhập với tài khoản quản trị, bảng danh sách người dùng
  sẽ được tải từ Firestore và hiển thị cùng với tuỳ chọn nạp thêm năng lượng.
  Chức năng trừ năng lượng được bổ sung với một nút "Trừ" nằm cạnh nút "Nạp".
  Bạn có thể sửa đổi hoặc mở rộng file này tùy theo nhu cầu.
-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang Quản Trị Long Bảo A.I.</title>
    <!-- Sử dụng Tailwind CSS để nhanh chóng xây dựng giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Nạp module Firebase dùng dạng ESM -->
    <script type="module">
        // --- Khởi tạo Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Sao chép cấu hình Firebase từ dự án gốc. Giá trị này có sẵn trong file MÃ NGUỒN LB 4.html.
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyCHDzGbXmHNWKL2UtRm57vPRVxZb31dHto",
                authDomain: "long-bao-tool-ai.firebaseapp.com",
                projectId: "long-bao-tool-ai",
                storageBucket: "long-bao-tool-ai.appspot.com",
                messagingSenderId: "259613170671",
                appId: "1:259613170671:web:6fe2467879c01da52b41a"
            },
            authDomainSuffix: "@long-bao-tool-ai.web.app",
            energy: {
                initial: 5
            }
        };
        // Khởi tạo ứng dụng và các dịch vụ
        const firebaseApp = initializeApp(CONFIG.firebase);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // Truy xuất một số phần tử giao diện để điều khiển sau này
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const userTableBody = document.getElementById('user-table-body');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const createUserForm = document.getElementById('create-user-form');
        const refreshUsersBtn = document.getElementById('refresh-users-btn');

        // Phần tử tìm kiếm người dùng
        const searchInput = document.getElementById('search-user-input');
        const searchBtn = document.getElementById('search-user-btn');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        /**
         * Hiển thị thông báo đơn giản cho người dùng.  
         * Trong ứng dụng thực tế bạn có thể thay thế bằng UI đẹp hơn.
         * @param {string} message Nội dung thông báo
         * @param {string} type Phân loại thông báo: success | error | info
         */
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `${colors[type]} text-white px-4 py-2 rounded shadow fixed top-4 right-4 z-50`;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        /**
         * Tải danh sách người dùng từ Firestore. Nếu truyền tham số filterUsername,
         * chỉ hiển thị những người dùng có tên chứa chuỗi đó (không phân biệt hoa thường).
         * @param {string} [filterUsername] Tên người dùng muốn lọc (tùy chọn)
         */
        async function loadUsers(filterUsername) {
            userTableBody.innerHTML = '';
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                const filter = filterUsername ? filterUsername.toLowerCase() : null;
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    // Lọc theo tên nếu có filter
                    if (filter && !(data.username || '').toLowerCase().includes(filter)) return;
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-700';
                    // Cột UID
                    const uidTd = document.createElement('td');
                    uidTd.textContent = docSnap.id;
                    uidTd.className = 'px-2 py-1 text-xs break-all';
                    // Cột tên người dùng
                    const nameTd = document.createElement('td');
                    nameTd.textContent = data.username || '';
                    nameTd.className = 'px-2 py-1';
                    // Cột số điện thoại
                    const phoneTd = document.createElement('td');
                    phoneTd.textContent = data.phoneNumber || '';
                    phoneTd.className = 'px-2 py-1';
                    // Cột năng lượng hiện có
                    const energyTd = document.createElement('td');
                    energyTd.textContent = data.energy ?? 0;
                    energyTd.className = 'px-2 py-1';

                    // Cột cấp bậc (THƯỜNG / VIP / PREMIUM)
                    const levelTd = document.createElement('td');
                    const levelSelect = document.createElement('select');
                    // Use a wider width for readability
                    levelSelect.className = 'w-28 bg-gray-800 text-white border border-gray-600 rounded px-1';
                    const levels = [
                        { value: 'normal', label: 'THƯỜNG' },
                        { value: 'vip', label: 'VIP' },
                        { value: 'premium', label: 'PREMIUM' }
                    ];
                    levels.forEach(({ value, label }) => {
                        const opt = document.createElement('option');
                        opt.value = value;
                        opt.textContent = label;
                        levelSelect.appendChild(opt);
                    });
                    // Nếu chưa có trường cấp bậc thì mặc định là 'normal'
                    levelSelect.value = data.level || 'normal';
                    // Hàm trả về màu tương ứng với cấp bậc
                    const getLevelColor = (level) => {
                        switch (level) {
                            case 'vip':
                                return '#FFD700'; // vàng cho VIP
                            case 'premium':
                                return '#ff00ff'; // tím hồng cho PREMIUM
                            default:
                                return '#00ffff'; // cyan cho thường
                        }
                    };
                    // Đặt màu chữ và hiệu ứng ban đầu cho ô chọn
                    {
                        const initColor = getLevelColor(levelSelect.value);
                        levelSelect.style.color = initColor;
                        levelSelect.style.borderColor = initColor;
                        levelSelect.style.boxShadow = `0 0 6px ${initColor}`;
                        levelSelect.style.fontWeight = '700';
                    }
                    // Khi thay đổi cấp bậc, cập nhật Firestore và thay đổi màu chữ
                    levelSelect.onchange = async () => {
                        const newLevel = levelSelect.value;
                        const newColor = getLevelColor(newLevel);
                        // Cập nhật màu chữ và hiệu ứng viền cho cấp bậc mới
                        levelSelect.style.color = newColor;
                        levelSelect.style.borderColor = newColor;
                        levelSelect.style.boxShadow = `0 0 6px ${newColor}`;
                        try {
                            await updateDoc(doc(db, 'users', docSnap.id), { level: newLevel });
                            showToast(`Đã cập nhật cấp bậc cho ${data.username} thành ${newLevel.toUpperCase()}.`, 'success');
                            // Cập nhật dữ liệu trong bộ nhớ tạm của bảng
                            data.level = newLevel;
                        } catch (err) {
                            console.error(err);
                            showToast('Không thể cập nhật cấp bậc.', 'error');
                        }
                    };
                    levelTd.appendChild(levelSelect);
                    levelTd.className = 'px-2 py-1';
                    // Cột nhập số năng lượng cần nạp hoặc trừ
                    const inputTd = document.createElement('td');
                    const energyInput = document.createElement('input');
                    energyInput.type = 'number';
                    energyInput.min = '0';
                    energyInput.className = 'w-20 bg-gray-800 text-white border border-gray-600 rounded px-1';
                    inputTd.appendChild(energyInput);
                    // Cột hành động với nút nạp và trừ năng lượng
                    const actionTd = document.createElement('td');
                    // Chứa hai nút, sử dụng flex để canh ngang
                    const actionWrapper = document.createElement('div');
                    actionWrapper.className = 'flex space-x-2';
                    // Nút nạp
                    const addButton = document.createElement('button');
                    addButton.textContent = 'Nạp';
                    addButton.className = 'bg-cyan-600 hover:bg-cyan-700 text-white px-3 py-1 rounded';
                    addButton.onclick = async () => {
                        const value = parseInt(energyInput.value);
                        if (isNaN(value) || value <= 0) {
                            showToast('Vui lòng nhập số năng lượng hợp lệ.', 'error');
                            return;
                        }
                        try {
                            await updateDoc(doc(db, 'users', docSnap.id), {
                                energy: (data.energy ?? 0) + value
                            });
                            showToast(`Đã nạp ${value} năng lượng cho ${data.username}.`, 'success');
                            // Cập nhật cột năng lượng trong bảng
                            data.energy = (data.energy ?? 0) + value;
                            energyTd.textContent = data.energy;
                            energyInput.value = '';
                        } catch (err) {
                            console.error(err);
                            showToast('Không thể cập nhật năng lượng. Kiểm tra lại quyền hoặc mạng.', 'error');
                        }
                    };
                    actionWrapper.appendChild(addButton);
                    // Nút trừ năng lượng
                    const subtractButton = document.createElement('button');
                    subtractButton.textContent = 'Trừ';
                    subtractButton.className = 'bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded';
                    subtractButton.onclick = async () => {
                        const value = parseInt(energyInput.value);
                        if (isNaN(value) || value <= 0) {
                            showToast('Vui lòng nhập số năng lượng hợp lệ.', 'error');
                            return;
                        }
                        // Nếu năng lượng hiện tại không đủ
                        const currentEnergy = data.energy ?? 0;
                        if (currentEnergy - value < 0) {
                            showToast('Không đủ năng lượng để trừ.', 'error');
                            return;
                        }
                        try {
                            await updateDoc(doc(db, 'users', docSnap.id), {
                                energy: currentEnergy - value
                            });
                            showToast(`Đã trừ ${value} năng lượng của ${data.username}.`, 'success');
                            // Cập nhật cột năng lượng trong bảng
                            data.energy = currentEnergy - value;
                            energyTd.textContent = data.energy;
                            energyInput.value = '';
                        } catch (err) {
                            console.error(err);
                            showToast('Không thể cập nhật năng lượng. Kiểm tra lại quyền hoặc mạng.', 'error');
                        }
                    };
                    actionWrapper.appendChild(subtractButton);
                    actionTd.appendChild(actionWrapper);
                    actionTd.className = 'px-2 py-1';
                    tr.appendChild(uidTd);
                    tr.appendChild(nameTd);
                    tr.appendChild(phoneTd);
                    tr.appendChild(energyTd);
                    // Thêm cột cấp bậc vào sau năng lượng
                    tr.appendChild(levelTd);
                    tr.appendChild(inputTd);
                    tr.appendChild(actionTd);
                    userTableBody.appendChild(tr);
                });
                if (filter && !userTableBody.firstChild) {
                    showToast('Không tìm thấy người dùng phù hợp.', 'info');
                }
            } catch (error) {
                console.error(error);
                showToast('Không thể tải danh sách người dùng.', 'error');
            }
        }

        // Xử lý sự kiện đăng nhập cho quản trị viên
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('admin-username');
            const passwordInput = document.getElementById('admin-password');
            let identifier = usernameInput.value.trim();
            const password = passwordInput.value;
            if (!identifier || !password) {
                showToast('Vui lòng nhập đầy đủ thông tin đăng nhập.', 'error');
                return;
            }
            // Nếu người dùng không nhập ký tự '@', coi là tên đăng nhập và gắn thêm hậu tố email
            if (!identifier.includes('@')) {
                identifier = `${identifier.toLowerCase()}${CONFIG.authDomainSuffix}`;
            }
            try {
                // Thử đăng nhập bằng email/tên đăng nhập đã xác định
                await signInWithEmailAndPassword(auth, identifier, password);
                showToast('Đăng nhập thành công.', 'success');
            } catch (err) {
                console.error(err);
                if (err.code === 'auth/user-not-found') {
                    // Nếu tài khoản chưa tồn tại, tự động tạo tài khoản mới với thông tin được nhập
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, identifier, password);
                        // Thêm người dùng vào Firestore với dữ liệu tối thiểu
                        const newUsername = identifier.split('@')[0];
                        await setDoc(doc(db, 'users', userCredential.user.uid), {
                            uid: userCredential.user.uid,
                            username: newUsername,
                            phoneNumber: '',
                            energy: CONFIG.energy.initial,
                            // Mặc định cấp bậc là thường khi tạo mới
                            level: 'normal',
                            createdAt: serverTimestamp(),
                            avatarUrl: '',
                            f168Username: '',
                            f168UsernameLastChanged: null,
                            f168UsernameChangeCount: 0
                        });
                        showToast('Tài khoản mới đã được tạo và đăng nhập.', 'success');
                    } catch (createErr) {
                        console.error(createErr);
                        showToast('Không thể tạo tài khoản mới. Kiểm tra cấu hình Firebase.', 'error');
                    }
                } else if (err.code === 'auth/invalid-email') {
                    showToast('Email không hợp lệ.', 'error');
                } else if (err.code === 'auth/wrong-password') {
                    showToast('Mật khẩu không chính xác.', 'error');
                } else {
                    showToast('Đăng nhập thất bại. Kiểm tra lại thông tin.', 'error');
                }
            }
        });

        // Xử lý sự kiện đăng xuất
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Đã đăng xuất.', 'info');
            } catch (err) {
                console.error(err);
                showToast('Không thể đăng xuất.', 'error');
            }
        });

        // Xử lý tạo tài khoản người dùng mới
        createUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('new-username').value.trim().toLowerCase();
            const newPhone = document.getElementById('new-phone').value.trim();
            const newPassword = document.getElementById('new-password').value;
            const newEnergy = parseInt(document.getElementById('new-energy').value);
            if (!newUsername || !newPhone || !newPassword) {
                showToast('Vui lòng nhập đầy đủ thông tin người dùng.', 'error');
                return;
            }
            try {
                // Dùng hậu tố email như hệ thống gốc
                const email = `${newUsername}${CONFIG.authDomainSuffix}`;
                const userCredential = await createUserWithEmailAndPassword(auth, email, newPassword);
                // Ghi dữ liệu người dùng vào Firestore
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    username: newUsername,
                    phoneNumber: newPhone,
                    energy: isNaN(newEnergy) ? CONFIG.energy.initial : newEnergy,
                    // Khi tạo tài khoản mới ở trang quản trị, gán cấp bậc mặc định
                    level: 'normal',
                    createdAt: serverTimestamp(),
                    avatarUrl: '',
                    f168Username: '',
                    f168UsernameLastChanged: null,
                    f168UsernameChangeCount: 0
                });
                showToast('Tạo tài khoản thành công.', 'success');
                // Làm mới danh sách người dùng
                await loadUsers();
                // Xoá nội dung biểu mẫu
                createUserForm.reset();
            } catch (err) {
                console.error(err);
                showToast('Không thể tạo tài khoản. Có thể tài khoản đã tồn tại hoặc bạn không có quyền.', 'error');
            }
        });

        // Nút refresh để tải lại danh sách người dùng thủ công
        refreshUsersBtn.addEventListener('click', loadUsers);

        // Tìm kiếm người dùng khi nhấn nút tìm
        searchBtn.addEventListener('click', () => {
            const term = searchInput.value.trim();
            loadUsers(term);
        });

        // Xoá bộ lọc tìm kiếm và hiển thị lại tất cả
        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            loadUsers();
        });

        // Theo dõi trạng thái đăng nhập. Nếu đã đăng nhập, hiển thị khu vực quản trị
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                loadUsers();
            } else {
                adminSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
                userTableBody.innerHTML = '';
            }
        });
    </script>
</head>
<body class="bg-[#0A192F] text-white min-h-screen flex flex-col items-center p-4">
    <h1 class="text-2xl font-bold mb-4">Trang quản trị Long Bảo A.I</h1>
    <!-- Khu vực đăng nhập -->
    <section id="login-section" class="w-full max-w-md bg-gray-800 p-6 rounded shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Đăng nhập quản trị viên</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="admin-username" class="block mb-1">Tên đăng nhập hoặc email</label>
                <input id="admin-username" type="text" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" placeholder="Tên đăng nhập hoặc email" />
            </div>
            <div>
                <label for="admin-password" class="block mb-1">Mật khẩu</label>
                <input id="admin-password" type="password" class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded" placeholder="Mật khẩu" />
            </div>
            <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded">Đăng nhập</button>
        </form>
    </section>
    <!-- Khu vực quản trị -->
    <section id="admin-section" class="w-full hidden max-w-4xl mt-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Quản lý người dùng</h2>
            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Đăng xuất</button>
        </div>
        <!-- Tạo người dùng mới -->
        <div class="bg-gray-800 p-4 rounded mb-6">
            <h3 class="text-lg font-medium mb-3">Tạo người dùng mới</h3>
            <form id="create-user-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label for="new-username" class="block mb-1">Tên người dùng</label>
                    <input id="new-username" type="text" class="w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded" placeholder="Tên đăng nhập" />
                </div>
                <div>
                    <label for="new-phone" class="block mb-1">Số điện thoại</label>
                    <input id="new-phone" type="text" class="w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded" placeholder="Số điện thoại" />
                </div>
                <div>
                    <label for="new-password" class="block mb-1">Mật khẩu</label>
                    <input id="new-password" type="password" class="w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded" placeholder="Mật khẩu" />
                </div>
                <div>
                    <label for="new-energy" class="block mb-1">Năng lượng ban đầu</label>
                    <!-- Mặc định 5 giống cấu hình năng lượng ban đầu -->
                    <input id="new-energy" type="number" min="0" class="w-full px-2 py-1 bg-gray-900 border border-gray-700 rounded" placeholder="Mặc định 5" />
                </div>
                <div class="md:col-span-4">
                    <button type="submit" class="mt-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded w-full md:w-auto">Tạo tài khoản</button>
                </div>
            </form>
        </div>
        <!-- Danh sách người dùng -->
        <div class="bg-gray-800 p-4 rounded">
            <div class="flex flex-col md:flex-row md:items-end md:justify-between mb-3 space-y-3 md:space-y-0">
                <div>
                    <h3 class="text-lg font-medium mb-1">Danh sách người dùng</h3>
                    <div class="flex space-x-2">
                        <input id="search-user-input" type="text" class="px-2 py-1 bg-gray-900 border border-gray-700 rounded text-sm" placeholder="Tìm theo tên người dùng" />
                        <button id="search-user-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm">Tìm</button>
                        <button id="clear-search-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">Xóa</button>
                    </div>
                </div>
                <button id="refresh-users-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded self-start md:self-auto">Làm mới</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="px-2 py-1">UID</th>
                            <th class="px-2 py-1">Tên</th>
                            <th class="px-2 py-1">SĐT</th>
                            <th class="px-2 py-1">Năng lượng</th>
                            <!-- Cột cấp bậc người dùng (THƯỜNG / VIP / PREMIUM) -->
                            <th class="px-2 py-1">Cấp</th>
                            <th class="px-2 py-1">Nạp/Trừ</th>
                            <th class="px-2 py-1">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body" class="bg-gray-900">
                        <!-- Dòng người dùng sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</body>
</html>
